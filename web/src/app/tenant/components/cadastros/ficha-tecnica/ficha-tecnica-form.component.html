<div class="page">
  <!-- HEADER PADR√ÉO (igual Receita/Insumos) -->
  <mat-toolbar class="page-toolbar" color="transparent">
    <div class="title">
      <div class="h1">
        {{ isEdit() ? (isView() ? 'Visualizar ficha t√©cnica' : 'Editar ficha t√©cnica') : 'Cadastro de ficha t√©cnica' }}
      </div>
      <div class="subtitle" *ngIf="isEdit()">
        <mat-chip-set aria-label="status">
          <mat-chip [highlighted]="model.isAtivo">
            {{ model.isAtivo ? 'Ativa' : 'Inativa' }}
          </mat-chip>
          <mat-chip *ngIf="hasPorcao" highlighted>Com por√ß√£o</mat-chip>
          <mat-chip *ngIf="!hasPorcao">Sem por√ß√£o</mat-chip>
        </mat-chip-set>
      </div>
    </div>

    <span class="spacer"></span>

    <div class="actions">
      <button mat-stroked-button type="button" routerLink="/tenant/fichas-tecnicas">Voltar</button>

      @if (isView()) {
        <button mat-stroked-button type="button" (click)="openOperacao('comercial')">Opera√ß√£o</button>
        <button mat-stroked-button type="button" (click)="printPdf()">Imprimir / PDF</button>
      } @else {
        <button mat-raised-button color="primary" type="button" (click)="save()">Salvar</button>
      }
    </div>
  </mat-toolbar>

  <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedTabChange)="onTabChange($event.index)">
    <!-- TAB 1: CADASTRO -->
    <mat-tab label="Cadastro">
      <form #f="ngForm" (ngSubmit)="save()" class="content">

        <!-- Card: Identifica√ß√£o -->
        <mat-card class="card">
          <mat-card-title>Identifica√ß√£o</mat-card-title>
          <mat-card-content class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Categoria</mat-label>
              <mat-select name="categoriaId" [(ngModel)]="model.categoriaId" [disabled]="isView()" required>
                @for (c of categorias(); track c.id) {
                  <mat-option [value]="c.id">{{ c.nome }}</mat-option>
                }
              </mat-select>
              @if (f.controls['categoriaId']?.errors?.['required']) {
                <mat-error>Categoria √© obrigat√≥ria</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nome comercial</mat-label>
              <input matInput name="nome" [(ngModel)]="model.nome" [disabled]="isView()" required maxlength="200" />
              @if (f.controls['nome']?.errors?.['required']) {
                <mat-error>Nome √© obrigat√≥rio</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>C√≥digo</mat-label>
              <input matInput name="codigo" [(ngModel)]="model.codigo" [disabled]="isView()" maxlength="50" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Receita principal (produ√ß√£o)</mat-label>
              <mat-select name="receitaPrincipalId" [(ngModel)]="model.receitaPrincipalId" [disabled]="isView()">
                <mat-option [value]="null">Nenhuma</mat-option>
                @for (r of receitas(); track r.id) {
                  <mat-option [value]="r.id">{{ r.nome }}</mat-option>
                }
              </mat-select>
              <mat-hint>Usada na tela Opera√ß√£o (produ√ß√£o). Selecione a receita que descreve o passo a passo.</mat-hint>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Card: Precifica√ß√£o (cadastro) -->
        <mat-card class="card">
          <mat-card-title>Precifica√ß√£o (cadastro)</mat-card-title>
          <mat-card-content class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Markup (multiplicador)</mat-label>
              <input matInput type="number" name="indiceContabil" [(ngModel)]="model.indiceContabil"
                     [disabled]="isView()" required min="0.01" step="0.01" />
              <mat-hint>Pre√ßo mesa = custo √ó markup</mat-hint>
              @if (f.controls['indiceContabil']?.errors?.['required']) {
                <mat-error>Markup √© obrigat√≥rio</mat-error>
              }
              @if (f.controls['indiceContabil']?.errors?.['min']) {
                <mat-error>Markup deve ser maior que zero</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Forma de venda</mat-label>
              <mat-select name="formaVenda" [(ngModel)]="model.formaVenda" [disabled]="isView()">
                <mat-option value="porcao">Por√ß√£o em gr/ml</mat-option>
                <mat-option value="unidade">Unidade</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Margem alvo (%)</mat-label>
              <input matInput type="number" name="margemAlvoPercentual" [(ngModel)]="model.margemAlvoPercentual"
                     [disabled]="isView()" min="0" max="100" step="0.1" />
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Card: Por√ß√£o de venda -->
        <mat-card class="card" *ngIf="isView() || model.formaVenda === 'porcao'">
          <mat-card-title>Por√ß√£o de venda (1 venda = quanto?)</mat-card-title>
          <mat-card-content class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Quantidade por por√ß√£o</mat-label>
              <input matInput type="number" name="porcaoVendaQuantidade" [(ngModel)]="model.porcaoVendaQuantidade"
                     [disabled]="isView()" min="0" step="0.01" />
              <mat-hint>Quanto voc√™ serve em 1 venda? (Ex.: 150g, 100ml). Necess√°rio para custo/pre√ßo por por√ß√£o.</mat-hint>
              @if (model.porcaoVendaQuantidade && model.porcaoVendaQuantidade > 0 && !model.porcaoVendaUnidadeMedidaId) {
                <mat-error>Selecione a unidade da por√ß√£o</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Unidade</mat-label>
              <mat-select name="porcaoVendaUnidadeMedidaId" [(ngModel)]="model.porcaoVendaUnidadeMedidaId" [disabled]="isView()">
                <mat-option [value]="null">Selecione...</mat-option>
                @for (u of unidades(); track u.id) {
                  @if (u.sigla.toUpperCase() === 'GR' || u.sigla.toUpperCase() === 'ML') {
                    <mat-option [value]="u.id">{{ u.sigla }} - {{ u.nome }}</mat-option>
                  }
                }
              </mat-select>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Card: Perdas e coc√ß√£o -->
        <mat-card class="card">
          <mat-card-title>Perdas e Coc√ß√£o</mat-card-title>
          <mat-card-content class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Coc√ß√£o altera o peso?</mat-label>
              <mat-select name="icOperador" [(ngModel)]="model.icOperador" [disabled]="isView()">
                <mat-option [value]="null">N√£o aplicar</mat-option>
                <mat-option value="+">Aumenta</mat-option>
                <mat-option value="-">Diminui</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Varia√ß√£o na coc√ß√£o (%)</mat-label>
              <input matInput type="number" name="icValor" [(ngModel)]="model.icValor" [disabled]="isView()" min="0" max="9999" step="1" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Aproveitamento (%)</mat-label>
              <input matInput type="number" name="ipcValor" [(ngModel)]="model.ipcValor" [disabled]="isView()" min="0" max="999" step="1" />
              <mat-hint>100 = sem perda; 90 = 10% de perda (parte aproveit√°vel)</mat-hint>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Card: Produ√ß√£o -->
        <mat-card class="card" *ngIf="isView() || model.formaVenda === 'unidade'">
          <mat-card-title>Produ√ß√£o (Rendimento do lote)</mat-card-title>
          <mat-card-content class="grid">
            <mat-form-field appearance="outline">
              <mat-label>Tempo preparo (min)</mat-label>
              <input matInput type="number" name="tempoPreparo" [(ngModel)]="model.tempoPreparo" [disabled]="isView()" min="0" step="1" />
              <mat-hint>Tempo necess√°rio para produzir 1 lote completo</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Rendimento do lote (descri√ß√£o)</mat-label>
              <input matInput type="text" name="rendimentoPorcoes" [(ngModel)]="model.rendimentoPorcoes" [disabled]="isView()" maxlength="200"
                     placeholder="Ex.: 10 por√ß√µes, 4 palitos, 1 sandu√≠che, 500ml de molho" />
              <mat-hint>Descreva quantas por√ß√µes/unidades este lote produz</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Rendimento do lote (n√∫mero)</mat-label>
              <input matInput type="number" name="rendimentoPorcoesNumero" [(ngModel)]="model.rendimentoPorcoesNumero" [disabled]="isView()" min="0" step="0.01" />
              <mat-hint>Quantas unidades/por√ß√µes saem deste lote? (Ex.: 1 para hot dog, 10 para molho em batch)</mat-hint>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Card: Descri√ß√£o comercial -->
        <mat-card class="card">
          <mat-card-title>Descri√ß√£o comercial</mat-card-title>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full">
              <mat-label>Descri√ß√£o para card√°pio / canais</mat-label>
              <textarea matInput name="descricaoComercial" rows="4" [(ngModel)]="model.descricaoComercial" [disabled]="isView()" maxlength="5000"></textarea>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Card: Composi√ß√£o (Itens) -->
        <mat-card class="card">
          <mat-card-title>Composi√ß√£o (Itens)</mat-card-title>
          <mat-card-content>

            @if (!isView()) {
              <div class="card-actions">
                <button mat-raised-button color="primary" type="button" (click)="addItem()">
                  <mat-icon>add</mat-icon>
                  Adicionar item
                </button>
              </div>
            }

            <!-- Desktop: tabela -->
            @if (!isMobile() && itens().length > 0) {
              <div class="table-wrapper">
                <table mat-table [dataSource]="itens()" class="mat-elevation-z1 full-width-table">
                  <ng-container matColumnDef="ordem">
                    <th mat-header-cell *matHeaderCellDef class="col-ordem">Item</th>
                    <td mat-cell *matCellDef="let item" class="col-ordem">
                      @if (isView()) { {{ item.ordem }} }
                      @else { <input type="number" class="input-ordem" [(ngModel)]="item.ordem" [ngModelOptions]="{standalone: true}" min="1" /> }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="tipo">
                    <th mat-header-cell *matHeaderCellDef>Tipo</th>
                    <td mat-cell *matCellDef="let item">
                      @if (isView()) { {{ item.tipoItem }} }
                      @else {
                        <mat-form-field appearance="outline" class="cell-field">
                          <mat-select [(ngModel)]="item.tipoItem" [ngModelOptions]="{standalone: true}" (selectionChange)="onItemTipoChange(item)">
                            <mat-option value="Receita">Receita</mat-option>
                            <mat-option value="Insumo">Insumo</mat-option>
                          </mat-select>
                        </mat-form-field>
                      }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="item">
                    <th mat-header-cell *matHeaderCellDef>Item</th>
                    <td mat-cell *matCellDef="let item">
                      @if (isView()) { {{ getItemNome(item) }} }
                      @else {
                        @if (item.tipoItem === 'Receita') {
                          <mat-form-field appearance="outline" class="cell-field">
                            <mat-select [(ngModel)]="item.receitaId" [ngModelOptions]="{standalone: true}" (selectionChange)="onSelectReceita(item)">
                              <mat-option [value]="null">Selecione...</mat-option>
                              @for (r of receitas(); track r.id) { <mat-option [value]="r.id">{{ r.nome }}</mat-option> }
                            </mat-select>
                          </mat-form-field>
                        } @else {
                          <mat-form-field appearance="outline" class="cell-field">
                            <mat-select [(ngModel)]="item.insumoId" [ngModelOptions]="{standalone: true}" (selectionChange)="onSelectInsumo(item, $event.value)">
                              <mat-option [value]="null">Selecione...</mat-option>
                              @for (i of insumos(); track i.id) { <mat-option [value]="i.id">{{ i.nome }}</mat-option> }
                            </mat-select>
                          </mat-form-field>
                        }
                      }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="quantidade">
                    <th mat-header-cell *matHeaderCellDef>Quantidade</th>
                    <td mat-cell *matCellDef="let item">
                      @if (isView()) { {{ formatQuantidadeNumeroForm(item) }} }
                      @else {
                        <mat-form-field appearance="outline" class="cell-field">
                          <input matInput type="number"
                                 [ngModel]="getQuantidadeExibicao(item)"
                                 (ngModelChange)="onQuantidadeExibicaoChange(item, $event)"
                                 [ngModelOptions]="{standalone: true}"
                                 [min]="getQuantidadeMin(item)"
                                 [step]="getQuantidadeStep(item)" />
                        </mat-form-field>
                      }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="unidade">
                    <th mat-header-cell *matHeaderCellDef>Unidade</th>
                    <td mat-cell *matCellDef="let item">
                      @if (isView()) { {{ getUnidadeSigla(item.unidadeMedidaId) }} }
                      @else {
                        @if (isUnidadeTravada(item)) {
                          <span class="locked">{{ getUnidadeSigla(item.unidadeMedidaId) }}</span>
                        } @else {
                          <mat-form-field appearance="outline" class="cell-field">
                            <mat-select [(ngModel)]="item.unidadeMedidaId" [ngModelOptions]="{standalone: true}">
                              <mat-option [value]="null">Selecione...</mat-option>
                              @for (u of getUnidadesPermitidas(item); track u.id) {
                                <mat-option [value]="u.id">{{ getUnidadeSigla(u.id) }} - {{ u.nome }}</mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                        }
                      }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="qb">
                    <th mat-header-cell *matHeaderCellDef class="col-qb">QB</th>
                    <td mat-cell *matCellDef="let item" class="col-qb">
                      @if (isView()) { {{ item.exibirComoQB ? 'Sim' : 'N√£o' }} }
                      @else { <mat-checkbox [(ngModel)]="item.exibirComoQB" [ngModelOptions]="{standalone: true}"></mat-checkbox> }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="observacoes">
                    <th mat-header-cell *matHeaderCellDef>Observa√ß√µes</th>
                    <td mat-cell *matCellDef="let item">
                      @if (isView()) { {{ item.observacoes || '-' }} }
                      @else {
                        <mat-form-field appearance="outline" class="cell-field">
                          <input matInput [(ngModel)]="item.observacoes" [ngModelOptions]="{standalone: true}" placeholder="Opcional" />
                        </mat-form-field>
                      }
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="acoes">
                    <th mat-header-cell *matHeaderCellDef class="col-acoes">A√ß√µes</th>
                    <td mat-cell *matCellDef="let item; let i = index" class="col-acoes">
                      @if (!isView()) {
                        <button mat-icon-button type="button" (click)="removeItem(i)" color="warn" matTooltip="Remover item">
                          <mat-icon>delete</mat-icon>
                        </button>
                      }
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumnsItens"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumnsItens"></tr>
                </table>
              </div>
            }

            <!-- Mobile: cards -->
            @if (isMobile() && itens().length > 0) {
              <div class="items-cards">
                @for (item of itens(); track $index; let i = $index) {
                  <mat-card class="item-card">
                    <mat-card-content>
                      <div class="item-head">
                        <div class="item-title">#{{ item.ordem }} ‚Äî {{ item.tipoItem }}</div>
                        @if (!isView()) {
                          <button mat-icon-button type="button" (click)="removeItem(i)" color="warn" matTooltip="Remover">
                            <mat-icon>delete</mat-icon>
                          </button>
                        }
                      </div>

                      <div class="item-body">
                        <div class="row">
                          <div class="label">Item</div>
                          <div class="value">{{ getItemNome(item) }}</div>
                        </div>

                        <div class="row">
                          <div class="label">Quantidade</div>
                          <div class="value">{{ formatQuantidadeFormItem(item) }}</div>
                        </div>

                        <div class="row" *ngIf="item.observacoes">
                          <div class="label">Observa√ß√µes</div>
                          <div class="value">{{ item.observacoes }}</div>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                }
              </div>
            }

            @if (itens().length === 0) {
              <div class="empty">Nenhum item adicionado.</div>
            }
          </mat-card-content>
        </mat-card>

        <!-- Card: Custos (somente leitura) + CTA para Resumo -->
        <mat-card class="card">
          <mat-card-title>Custos e pre√ßos (somente leitura)</mat-card-title>
          <mat-card-content>
            <div class="kpis">
              <div class="kpi">
                <div class="kpi-label">Custo total</div>
                <div class="kpi-value">{{ formatCurrency(custoTotalCalculado) }}</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Custo por gr/ml</div>
                <div class="kpi-value">{{ formatNumber(custoPorGmlCalculado) }}</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Pre√ßo mesa</div>
                <div class="kpi-value">
                  @if (precoMesaCalculado === null) { ‚Äî } @else { {{ formatCurrency(precoMesaCalculado) }} }
                </div>
              </div>
            </div>

            <div class="inline-actions">
              <button mat-stroked-button type="button" (click)="goToPlanilhaTab()">Ver resumo</button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Card: Canais -->
        <mat-card class="card">
          <mat-card-title>Canais comerciais</mat-card-title>
          <mat-card-content>
            <div class="presets-row">
              <span class="presets-label">Presets:</span>
              <button mat-stroked-button type="button" (click)="addCanalPreset('IFOOD1')" [disabled]="isView()">iFood 1</button>
              <button mat-stroked-button type="button" (click)="addCanalPreset('IFOOD2')" [disabled]="isView()">iFood 2</button>
              <button mat-stroked-button type="button" (click)="addCanalPreset('BALCAO')" [disabled]="isView()">Balc√£o</button>
              <button mat-stroked-button type="button" (click)="addCanalPreset('DELIVERY')" [disabled]="isView()">Delivery pr√≥prio</button>
            </div>

            <div class="table-wrapper">
              <table mat-table [dataSource]="canais()" class="full-width-table">
                <ng-container matColumnDef="canal">
                  <th mat-header-cell *matHeaderCellDef>Canal</th>
                  <td mat-cell *matCellDef="let item; let i = index">
                    @if (isView()) {
                      {{ item.canal }}
                    } @else {
                      <mat-form-field appearance="outline" class="cell-field">
                        <mat-label>Selecione o canal</mat-label>
                        <mat-select [(ngModel)]="item.canalVendaId" [ngModelOptions]="{standalone: true}" (selectionChange)="onCanalVendaSelected(i, item.canalVendaId ?? null)">
                          <mat-option [value]="null">-- Digite manualmente --</mat-option>
                          @for (canal of canaisVenda(); track canal.id) {
                            <mat-option [value]="canal.id">{{ canal.nome }}@if (canal.taxaPercentualPadrao) { ({{ canal.taxaPercentualPadrao }}%)}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>

                      @if (!item.canalVendaId) {
                        <mat-form-field appearance="outline" class="cell-field mt8">
                          <input matInput [(ngModel)]="item.canal" [ngModelOptions]="{standalone: true}" placeholder="Ex.: ifood-1, BALCAO" />
                        </mat-form-field>
                      }
                    }
                  </td>
                </ng-container>

                <ng-container matColumnDef="nomeExibicao">
                  <th mat-header-cell *matHeaderCellDef>Nome exibi√ß√£o</th>
                  <td mat-cell *matCellDef="let item">
                    @if (isView()) { {{ item.nomeExibicao || '-' }} }
                    @else {
                      <mat-form-field appearance="outline" class="cell-field">
                        <input matInput [(ngModel)]="item.nomeExibicao" [ngModelOptions]="{standalone: true}" placeholder="Ex.: iFood 1" />
                      </mat-form-field>
                    }
                  </td>
                </ng-container>

                <ng-container matColumnDef="precoVenda">
                  <th mat-header-cell *matHeaderCellDef>Pre√ßo venda</th>
                  <td mat-cell *matCellDef="let item">
                    @if (isView()) {
                      {{ formatCurrency(item.precoVenda) }}
                    } @else {
                      <mat-form-field appearance="outline" class="cell-field">
                        <input matInput type="number" [(ngModel)]="item.precoVenda" [ngModelOptions]="{standalone: true}" min="0" step="0.01"
                               placeholder="0 = calcular automaticamente" />
                      </mat-form-field>
                    }
                  </td>
                </ng-container>

                <ng-container matColumnDef="taxas">
                  <th mat-header-cell *matHeaderCellDef>Taxas (%)</th>
                  <td mat-cell *matCellDef="let item">
                    @if (isView()) {
                      <div>Taxa: {{ item.taxaPercentual ?? 0 }}%</div>
                    } @else {
                      <mat-form-field appearance="outline" class="cell-field">
                        <mat-label>Taxa canal (%)</mat-label>
                        <input matInput type="number" [(ngModel)]="item.taxaPercentual" [ngModelOptions]="{standalone: true}" min="0" max="100" step="0.1" />
                      </mat-form-field>
                    }
                  </td>
                </ng-container>

                <ng-container matColumnDef="porcentagem">
                  <th mat-header-cell *matHeaderCellDef>Porcentagem</th>
                  <td mat-cell *matCellDef="let item">
                    {{ item.margemCalculadaPercentual ? (item.margemCalculadaPercentual | number:'1.0-2') + '%' : '-' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="acoes">
                  <th mat-header-cell *matHeaderCellDef>A√ß√µes</th>
                  <td mat-cell *matCellDef="let item; let i = index">
                    @if (!isView()) {
                      <button mat-icon-button type="button" (click)="removeCanal(i)" color="warn" matTooltip="Remover canal">
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>

            @if (canais().length === 0) {
              <div class="empty">Nenhum canal adicionado.</div>
            }
          </mat-card-content>
        </mat-card>

        <div class="footer-toggle">
          <mat-slide-toggle name="isAtivo" [(ngModel)]="model.isAtivo" [disabled]="isView()">Ativo</mat-slide-toggle>
        </div>

        @if (error()) {
          <div class="error">{{ error() }}</div>
        }
      </form>
    </mat-tab>

    <!-- TAB 2: RESUMO (mant√©m o que voc√™ j√° tem) -->
    <mat-tab label="Resumo">
      <div class="content">
        @if (isLoadingDetalhe()) {
          <div class="loading">
            <mat-spinner [diameter]="40"></mat-spinner>
            <div class="muted">Carregando‚Ä¶</div>
          </div>
        } @else if (!fichaDtoCompleto() || !fichaDtoCompleto()!.itens || fichaDtoCompleto()!.itens.length === 0) {
          <div class="empty">Nenhum dado dispon√≠vel. Adicione itens na aba "Cadastro".</div>
        } @else {
          <!-- Bloco A: Cards de topo -->
          <div class="kpis-grid">
            <!-- Card 1: Custo Total -->
            <mat-card class="op-card">
              <mat-card-content>
                <div class="mini-label">Custo Total</div>
                <div class="big">{{ formatCurrency(fichaDtoCompleto()!.custoTotal) }}</div>
              </mat-card-content>
            </mat-card>

            <!-- Card 2: Peso Total Base e Rendimento Final -->
            <mat-card class="op-card">
              <mat-card-content>
                <div class="mini-label">Peso Total Base</div>
                <div class="mid">
                  @if (fichaDtoCompleto()!.pesoTotalBase !== null && fichaDtoCompleto()!.pesoTotalBase !== undefined) {
                    {{ formatQuantidadeExibicao(fichaDtoCompleto()!.pesoTotalBase, getUnidadePorcao().unidade) }}
                  } @else {
                    -
                  }
                </div>
                <div class="mini-label mt8">Rendimento Final (ap√≥s IC/IPC)</div>
                <div class="mid">
                  @if (fichaDtoCompleto()!.rendimentoFinal !== null && fichaDtoCompleto()!.rendimentoFinal !== undefined) {
                    {{ formatQuantidadeExibicao(fichaDtoCompleto()!.rendimentoFinal, getUnidadePorcao().unidade) }}
                  } @else {
                    -
                  }
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Card 3: Custo/kg final -->
            <mat-card class="op-card">
              <mat-card-content>
                <div class="mini-label">Custo/kg final</div>
                <div class="big">
                  @if (fichaDtoCompleto()!.custoKgL !== null && fichaDtoCompleto()!.custoKgL !== undefined) {
                    {{ formatCurrency(fichaDtoCompleto()!.custoKgL ?? 0) }}/{{ getUnidadePorcao().unidadePreco.replace('R$/', '') }}
                  } @else {
                    -
                  }
                </div>
                @if (fichaDtoCompleto()!.custoKgBase !== null && fichaDtoCompleto()!.custoKgBase !== undefined) {
                  <div class="mini-label mt8">Custo/kg base: {{ formatCurrency(fichaDtoCompleto()!.custoKgBase ?? 0) }}/{{ getUnidadePorcao().unidadePreco.replace('R$/', '') }}</div>
                }
              </mat-card-content>
            </mat-card>

            <!-- Card 4: Por√ß√£o / Custo por Por√ß√£o / Pre√ßo Mesa -->
            <mat-card class="op-card">
              <mat-card-content>
                <!-- Modo unidade (rendimentoPorcoesNumero) -->
                @if (fichaDtoCompleto()?.rendimentoPorcoesNumero && (fichaDtoCompleto()?.rendimentoPorcoesNumero ?? 0) > 0) {
                  <div class="mini-label">Rendimento do lote</div>
                  <div class="mid">
                    {{ fichaDtoCompleto()!.rendimentoPorcoesNumero }} {{ fichaDtoCompleto()!.rendimentoPorcoes || 'unidades' }}
                  </div>
                  <div class="mini-label mt8">1 venda</div>
                  <div class="mid">
                    @if (fichaDtoCompleto()!.porcaoVendaQuantidade) {
                      {{ formatQuantidadeExibicao(fichaDtoCompleto()!.porcaoVendaQuantidade, getUnidadePorcao().unidade) }}
                    } @else {
                      ‚Äî
                    }
                  </div>
                  <div class="mini-label mt8">Custo por unidade</div>
                  <div class="mid">
                    @if (fichaDtoCompleto()!.custoPorPorcaoVenda !== null && fichaDtoCompleto()!.custoPorPorcaoVenda !== undefined) {
                      {{ formatCurrency(fichaDtoCompleto()!.custoPorPorcaoVenda ?? 0) }}
                    } @else {
                      -
                    }
                  </div>
                  <div class="mini-label mt8">Pre√ßo mesa</div>
                  <div class="big">
                    @if (fichaDtoCompleto()!.precoMesaSugerido !== null && fichaDtoCompleto()!.precoMesaSugerido !== undefined) {
                      {{ formatCurrency(fichaDtoCompleto()!.precoMesaSugerido ?? 0) }}
                    } @else {
                      -
                    }
                  </div>
                } @else {
                  <!-- Modo por√ß√£o (porcaoVendaQuantidade) -->
                  <div class="mini-label">Por√ß√£o</div>
                  <div class="mid">
                    @if (fichaDtoCompleto()!.porcaoVendaQuantidade) {
                      {{ formatQuantidadeExibicao(fichaDtoCompleto()!.porcaoVendaQuantidade, getUnidadePorcao().unidade) }}
                    } @else {
                      -
                    }
                  </div>
                  <div class="mini-label mt8">Custo por por√ß√£o</div>
                  <div class="mid">
                    @if (fichaDtoCompleto()!.custoPorPorcaoVenda !== null && fichaDtoCompleto()!.custoPorPorcaoVenda !== undefined) {
                      {{ formatCurrency(fichaDtoCompleto()!.custoPorPorcaoVenda ?? 0) }}
                    } @else {
                      -
                    }
                  </div>
                  <div class="mini-label mt8">Pre√ßo mesa</div>
                  <div class="big">
                    @if (fichaDtoCompleto()!.precoMesaSugerido !== null && fichaDtoCompleto()!.precoMesaSugerido !== undefined) {
                      {{ formatCurrency(fichaDtoCompleto()!.precoMesaSugerido ?? 0) }}
                    } @else {
                      -
                    }
                  </div>
                }
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Bloco B: Tabela Composi√ß√£o -->
          <mat-card class="card">
            <mat-card-title>Composi√ß√£o</mat-card-title>
            <mat-card-content>
              <div class="table-wrapper">
                <table mat-table [dataSource]="fichaDtoCompleto()!.itens" class="mat-elevation-z1 full-width-table">
                  <ng-container matColumnDef="ordem">
                    <th mat-header-cell *matHeaderCellDef class="col-ordem">#</th>
                    <td mat-cell *matCellDef="let item" class="col-ordem">{{ item.ordem }}</td>
                    <td mat-footer-cell *matFooterCellDef class="col-ordem"><strong>Total</strong></td>
                  </ng-container>

                  <ng-container matColumnDef="tipo">
                    <th mat-header-cell *matHeaderCellDef>Tipo</th>
                    <td mat-cell *matCellDef="let item">{{ item.tipoItem }}</td>
                    <td mat-footer-cell *matFooterCellDef></td>
                  </ng-container>

                  <ng-container matColumnDef="item">
                    <th mat-header-cell *matHeaderCellDef>Item</th>
                    <td mat-cell *matCellDef="let item">{{ item.receitaNome || item.insumoNome || '-' }}</td>
                    <td mat-footer-cell *matFooterCellDef></td>
                  </ng-container>

                  <ng-container matColumnDef="quantidade">
                    <th mat-header-cell *matHeaderCellDef>Quantidade + Unidade</th>
                    <td mat-cell *matCellDef="let item">{{ formatQuantidadeItem(item) }}</td>
                    <td mat-footer-cell *matFooterCellDef></td>
                  </ng-container>

                  <ng-container matColumnDef="pesoPorUn">
                    <th mat-header-cell *matHeaderCellDef>{{ hasReceitaItems ? 'Peso por preparo' : 'Peso/UN (gr)' }}</th>
                    <td mat-cell *matCellDef="let item">
                      @if (item.pesoPorUnidadeGml !== null && item.pesoPorUnidadeGml !== undefined) {
                        {{ formatNumber(item.pesoPorUnidadeGml) }}
                      } @else {
                        -
                      }
                    </td>
                    <td mat-footer-cell *matFooterCellDef></td>
                  </ng-container>

                  <ng-container matColumnDef="pesoItem">
                    <th mat-header-cell *matHeaderCellDef>{{ hasReceitaItems ? 'Peso total do preparo' : 'Peso item (gr/ml)' }}</th>
                    <td mat-cell *matCellDef="let item">{{ formatNumber(item.pesoItemGml || 0) }}</td>
                    <td mat-footer-cell *matFooterCellDef>
                      <strong>{{ formatNumber(fichaDtoCompleto()!.pesoTotalBase ?? 0) }}</strong>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="custoItem">
                    <th mat-header-cell *matHeaderCellDef>Custo item (R$)</th>
                    <td mat-cell *matCellDef="let item">{{ formatCurrency(item.custoItem || 0) }}</td>
                    <td mat-footer-cell *matFooterCellDef><strong>{{ formatCurrency(fichaDtoCompleto()!.custoTotal) }}</strong></td>
                  </ng-container>

                  <ng-container matColumnDef="observacoes">
                    <th mat-header-cell *matHeaderCellDef>Observa√ß√µes</th>
                    <td mat-cell *matCellDef="let item">{{ item.observacoes || '-' }}</td>
                    <td mat-footer-cell *matFooterCellDef></td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['ordem', 'tipo', 'item', 'quantidade', 'pesoPorUn', 'pesoItem', 'custoItem', 'observacoes']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['ordem', 'tipo', 'item', 'quantidade', 'pesoPorUn', 'pesoItem', 'custoItem', 'observacoes']"></tr>
                  <tr mat-footer-row *matFooterRowDef="['ordem', 'tipo', 'item', 'quantidade', 'pesoPorUn', 'pesoItem', 'custoItem', 'observacoes']"></tr>
                </table>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Bloco D: Canais -->
          <mat-card class="card">
            <mat-card-title>Canais</mat-card-title>
            <mat-card-content>
              <div class="table-wrapper">
                <table mat-table [dataSource]="fichaDtoCompleto()!.canais" class="full-width-table">
                  <ng-container matColumnDef="canal">
                    <th mat-header-cell *matHeaderCellDef>Canal</th>
                    <td mat-cell *matCellDef="let item">{{ item.canal }}</td>
                  </ng-container>

                  <ng-container matColumnDef="nomeExibicao">
                    <th mat-header-cell *matHeaderCellDef>Nome exibi√ß√£o</th>
                    <td mat-cell *matCellDef="let item">{{ item.nomeExibicao || '-' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="precoCanal">
                    <th mat-header-cell *matHeaderCellDef>Pre√ßo Canal</th>
                    <td mat-cell *matCellDef="let item">{{ formatCurrency(item.precoVenda) }}</td>
                  </ng-container>

                  <ng-container matColumnDef="porcentagem">
                    <th mat-header-cell *matHeaderCellDef>Porcentagem (%)</th>
                    <td mat-cell *matCellDef="let item">
                      {{ item.margemCalculadaPercentual ? (item.margemCalculadaPercentual | number:'1.0-2') + '%' : '-' }}
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['canal', 'nomeExibicao', 'precoCanal', 'porcentagem']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['canal', 'nomeExibicao', 'precoCanal', 'porcentagem']"></tr>
                </table>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    </mat-tab>

    <!-- TAB 3: OPERA√á√ÉO (COZINHA) -->
    <mat-tab label="Opera√ß√£o">
      <div class="content">
        @if (isLoadingDetalhe()) {
          <div class="loading">
            <mat-spinner [diameter]="40"></mat-spinner>
            <div class="muted">Carregando‚Ä¶</div>
          </div>
        } @else if (!fichaDtoCompleto()) {
          <div class="empty">Nenhum dado dispon√≠vel.</div>
        } @else {
          <!-- KPIs operacionais (simples) -->
          <div class="op-kpis">
            <mat-card class="op-card">
              <mat-card-content>
                <div class="op-title">{{ fichaDtoCompleto()!.nome }}</div>
                <div class="op-subtitle" *ngIf="model.tempoPreparo">
                  ‚è± Tempo: {{ model.tempoPreparo }} min/lote
                </div>
                <div class="op-subtitle" *ngIf="model.rendimentoPorcoes">
                  üì¶ Lote rende: {{ model.rendimentoPorcoes }}
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="op-card">
              <mat-card-content>
                <div class="mini-label">Peso total base</div>
                <div class="big">
                  {{ formatQuantidadeExibicao(fichaDtoCompleto()!.pesoTotalBase ?? null, getUnidadePorcao().unidade) }}
                </div>
                <div class="mini-label mt8">Peso final (IC/IPC)</div>
                <div class="mid">
                  {{ formatQuantidadeExibicao(fichaDtoCompleto()!.rendimentoFinal ?? null, getUnidadePorcao().unidade) }}
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="op-card">
              <mat-card-content>
                <div class="mini-label">1 Por√ß√£o de venda</div>
                <div class="big">
                  @if (fichaDtoCompleto()!.porcaoVendaQuantidade) {
                    {{ formatQuantidadeExibicao(fichaDtoCompleto()!.porcaoVendaQuantidade, getUnidadePorcao().unidade) }}
                  } @else {
                    ‚Äî
                  }
                </div>

                <div class="mini-label mt8">Por√ß√µes no lote (estimativa)</div>
                <div class="mid">
                  {{ getPorcoesEstimadasOperacao() }}
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Lista de ingredientes/componentes (o que o cozinheiro quer ver) -->
          <mat-card class="card">
            <mat-card-title>Ingredientes / Componentes</mat-card-title>
            <mat-card-content>

              <div class="op-list">
                @for (it of fichaDtoCompleto()!.itens; track it.ordem) {
                  <mat-card class="op-item">
                    <mat-card-content>
                      <div class="op-item-head">
                        <div class="name">
                          <span class="badge">{{ it.tipoItem }}</span>
                          <span>{{ it.receitaNome || it.insumoNome }}</span>
                        </div>
                        <div class="qty">
                          {{ formatQuantidadeItem(it) }}
                        </div>
                      </div>

                      <!-- EQUIVAL√äNCIA (o pedido do cliente) -->
                      <div class="op-item-sub" *ngIf="getEquivalenciaPeso(it) as eq">
                        <span class="muted">Equival√™ncia:</span>
                        <strong>{{ eq }}</strong>
                      </div>

                      <div class="op-item-sub" *ngIf="it.observacoes">
                        <span class="muted">Obs:</span> {{ it.observacoes }}
                      </div>
                    </mat-card-content>
                  </mat-card>
                }
              </div>

              <div class="inline-actions">
                <button mat-stroked-button type="button" (click)="printPdf()">Imprimir / PDF</button>
                @if (model.receitaPrincipalId) {
                  <button mat-stroked-button type="button" (click)="openOperacao('producao')">Abrir Produ√ß√£o</button>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Passo a passo (se houver receita principal, voc√™ pode renderizar descri√ß√£o/instru√ß√µes nessa tela depois) -->
          <mat-card class="card" *ngIf="model.receitaPrincipalId">
            <mat-card-title>Preparo</mat-card-title>
            <mat-card-content class="muted">
              Use a receita principal selecionada para o passo a passo na tela de produ√ß√£o.
            </mat-card-content>
          </mat-card>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
