<mat-toolbar class="page-toolbar" color="primary">
  <button mat-icon-button type="button" routerLink="/tenant/receitas" aria-label="Voltar">
    <mat-icon>arrow_back</mat-icon>
  </button>

  <div class="toolbar-title">
    <div class="title">
      {{ isEdit() ? (isView() ? 'Visualizar receita' : 'Editar receita') : 'Cadastro de receita' }}
    </div>
    <div class="subtitle" *ngIf="isEdit()">
      ID: {{ id() }}
    </div>
  </div>

  <span class="spacer"></span>

  <mat-chip-set class="toolbar-chips" aria-label="Status">
    <mat-chip [disabled]="isView()" [class.chip-active]="model.isAtivo" [class.chip-inactive]="!model.isAtivo">
      {{ model.isAtivo ? 'Ativo' : 'Inativo' }}
    </mat-chip>
  </mat-chip-set>

  @if (isView()) {
    <button mat-stroked-button type="button" (click)="printPdf()">
      <mat-icon>print</mat-icon>
      Imprimir / PDF
    </button>
  } @else {
    <button mat-raised-button color="accent" type="submit" form="receitaForm">
      <mat-icon>save</mat-icon>
      Salvar
    </button>
  }
</mat-toolbar>

<mat-sidenav-container class="page-shell">
  <!-- Resumo (desktop) -->
  <mat-sidenav #summary mode="side" position="end" [opened]="!isMobile()" class="summary-sidenav">
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>Resumo</mat-card-title>
        <mat-card-subtitle>Valores e consistência</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content class="summary-content">
        <div class="summary-row">
          <div class="label">Custo total</div>
          <div class="value">{{ formatCurrency(custoTotalCalculado) }}</div>
        </div>
        <div class="summary-row">
          <div class="label">Custo por porção</div>
          <div class="value">{{ formatCurrency(custoPorPorcaoCalculado) }}</div>
        </div>

        <mat-divider></mat-divider>

        <div class="summary-row">
          <div class="label">Rendimento</div>
          <div class="value">{{ model.rendimento || '-' }}</div>
        </div>

        <div class="summary-row" *ngIf="pesoTotalAposRendimento !== null">
          <div class="label">Peso total (após IC)</div>
          <div class="value">{{ formatQuantidadeNumero(pesoTotalAposRendimento, 'GR') }} g</div>
        </div>

        <div class="summary-row">
          <div class="label">Fator IC (peso)</div>
          <div class="value">{{ fatorRendimentoCalculado | number:'1.2-2' }}</div>
        </div>
        <div class="summary-row">
          <div class="label">Fator de custo (coeficiente)</div>
          <div class="value">{{ fatorCustoCalculado | number:'1.2-2' }}</div>
        </div>

        <mat-divider></mat-divider>

        @if (!isView()) {
          <div class="summary-hints">
            <mat-icon>info</mat-icon>
            <div>
              <div class="hint-title">Regra de unidades</div>
              <div class="hint-text">Cadastre itens apenas em GR, ML ou UN. Dados antigos são normalizados automaticamente.</div>
            </div>
          </div>

          <div class="summary-hints" *ngIf="!todosItensComPesoBase">
            <mat-icon>warning</mat-icon>
            <div>
              <div class="hint-title">Cálculo automático</div>
              <div class="hint-text">Para habilitar, os itens precisam estar em GR/ML ou em UN com peso por unidade.</div>
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>
  </mat-sidenav>

  <!-- Conteúdo principal -->
  <mat-sidenav-content class="page-content">
    <form id="receitaForm" #f="ngForm" (ngSubmit)="save()" class="form-root">
      @if (!isView()) {
        <mat-card class="info-card">
          <mat-card-content>
            <div class="info-card-title">
              <mat-icon>checklist</mat-icon>
              <span>Como cadastrar</span>
            </div>
            <ol class="info-steps">
              <li>Defina nome, categoria e rendimento.</li>
              <li>Opcional: informe o peso por porção.</li>
              <li>Configure IC (perda/ganho) para ajustar o peso final.</li>
              <li>Adicione os itens (insumos) com quantidades.</li>
            </ol>
          </mat-card-content>
        </mat-card>
      }

      <mat-tab-group class="form-tabs" dynamicHeight>
        <!-- TAB 1: Geral -->
        <mat-tab label="Geral">
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>Informações básicas</mat-card-title>
              <mat-card-subtitle>Identificação e categoria</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content class="section-grid">
              <mat-form-field appearance="outline">
                <mat-label>Nome</mat-label>
                <input matInput name="nome" [(ngModel)]="model.nome" [disabled]="isView()" required maxlength="200" />
                @if (f.controls['nome']?.errors?.['required']) { <mat-error>Nome é obrigatório</mat-error> }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Categoria</mat-label>
                <mat-select name="categoriaId" [(ngModel)]="model.categoriaId" [disabled]="isView()" required>
                  @for (c of categorias(); track c.id) {
                    <mat-option [value]="c.id">{{ c.nome }}</mat-option>
                  }
                </mat-select>
                @if (f.controls['categoriaId']?.errors?.['required']) { <mat-error>Categoria é obrigatória</mat-error> }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Versão</mat-label>
                <input matInput name="versao" [(ngModel)]="model.versao" [disabled]="isView()" maxlength="20" />
                <mat-hint>Ex: 1.0, 2.1, 3.0</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Tempo de Preparo (min)</mat-label>
                <input matInput type="number" name="tempoPreparo" [(ngModel)]="model.tempoPreparo" [disabled]="isView()" min="1" />
              </mat-form-field>
            </mat-card-content>
          </mat-card>
        </mat-tab>

        <!-- TAB 2: Rendimento -->
        <mat-tab label="Rendimento">
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>Rendimento e IC</mat-card-title>
              <mat-card-subtitle>Peso final e porções</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              @if (!isView()) {
                <div class="toggle-row">
                  <mat-slide-toggle
                    [(ngModel)]="model.calcularRendimentoAutomatico"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="onToggleChange()"
                    [disabled]="isView() || !todosItensComPesoBase">
                    Calcular rendimento automaticamente (peso por porção)
                  </mat-slide-toggle>

                  <button mat-stroked-button type="button" class="help-btn" (click)="$event.preventDefault()">
                    <mat-icon>help_outline</mat-icon>
                    Dica
                  </button>
                </div>

                @if (!todosItensComPesoBase) {
                  <div class="inline-callout">
                    <mat-icon>info</mat-icon>
                    <span>Para ativar o cálculo automático, os itens precisam estar em GR/ML ou em UN com peso por unidade.</span>
                  </div>
                }
              }

              <div class="section-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Rendimento (porções)</mat-label>
                  <input
                    matInput type="number" name="rendimento"
                    [(ngModel)]="model.rendimento"
                    (ngModelChange)="onRendimentoChange()"
                    [disabled]="isView() || model.calcularRendimentoAutomatico"
                    required min="0.01" step="0.01" />
                  <mat-hint *ngIf="pesoTotalAposRendimento !== null">
                    Peso total (após IC): {{ formatQuantidadeNumero(pesoTotalAposRendimento, 'GR') }} g
                  </mat-hint>
                  @if (f.controls['rendimento']?.errors?.['required']) { <mat-error>Rendimento é obrigatório</mat-error> }
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Peso por porção (g)</mat-label>
                  <input
                    matInput type="number" name="pesoPorPorcao"
                    [(ngModel)]="model.pesoPorPorcao"
                    (ngModelChange)="onPesoPorPorcaoChange()"
                    [disabled]="isView() || (!model.calcularRendimentoAutomatico && pesoTotalAposRendimento === null)"
                    min="0.01" step="0.01" />
                  <mat-hint *ngIf="pesoTotalAposRendimento !== null && model.rendimento > 0">
                    Peso por porção (calculado a partir do peso final): {{ formatQuantidadeNumero(pesoTotalAposRendimento / model.rendimento, 'GR') }} g
                  </mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>IC - Sinal</mat-label>
                  <mat-select name="icSinal" [(ngModel)]="model.icSinal" (ngModelChange)="onICChange()" [disabled]="isView()">
                    <mat-option value="-">Perda (-)</mat-option>
                    <mat-option value="+">Ganho (+)</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>IC - Valor (%)</mat-label>
                  <input matInput type="number" name="icValor"
                         [(ngModel)]="model.icValor" (ngModelChange)="onICChange()"
                         [disabled]="isView()" min="0" [max]="icValorMax" step="0.01" />
                  <mat-hint>
                    IC ajusta o peso final. Ganho (+) reduz o custo por porção. Perda (-) aumenta o custo por porção.
                  </mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" disabled>
                  <mat-label>Fator IC (peso)</mat-label>
                  <input matInput [value]="fatorRendimentoCalculado | number:'1.2-2'" disabled />
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>
        </mat-tab>

        <!-- TAB 3: Itens -->
        <mat-tab label="Itens">
          <mat-card class="section-card">
            <mat-card-header class="items-header">
              <div>
                <mat-card-title>Itens da receita</mat-card-title>
                <mat-card-subtitle>Use apenas GR, ML ou UN</mat-card-subtitle>
              </div>

              @if (!isView()) {
                <button mat-raised-button color="primary" type="button" (click)="addItem()">
                  <mat-icon>add</mat-icon>
                  Adicionar item
                </button>
              }
            </mat-card-header>

            <mat-card-content>
              @if (itens().length === 0) {
                <div class="empty-state">
                  <mat-icon>inbox</mat-icon>
                  <div class="empty-title">Nenhum item adicionado</div>
                  <div class="empty-text">Clique em “Adicionar item” para começar.</div>
                </div>
              }

              @if (!isMobile() && itens().length > 0) {
                <div class="table-wrapper">
                  <table mat-table [dataSource]="itens()" class="full-width-table mat-elevation-z1">
                    <!-- Ordem -->
                    <ng-container matColumnDef="ordem">
                      <th mat-header-cell *matHeaderCellDef class="col-ordem">#</th>
                      <td mat-cell *matCellDef="let item" class="col-ordem">
                        @if (isView()) { {{ item.ordem }} }
                        @else { <input type="number" class="input-ordem" [(ngModel)]="item.ordem" [ngModelOptions]="{standalone: true}" min="1" /> }
                      </td>
                    </ng-container>

                    <!-- Insumo -->
                    <ng-container matColumnDef="insumo">
                      <th mat-header-cell *matHeaderCellDef>Insumo</th>
                      <td mat-cell *matCellDef="let item">
                        @if (isView()) { {{ getInsumoNome(item.insumoId) }} }
                        @else {
                          <mat-form-field appearance="outline" class="cell-field">
                            <mat-select [(ngModel)]="item.insumoId" [ngModelOptions]="{standalone: true}"
                                        (selectionChange)="onInsumoChange(item, 0)">
                              <mat-option [value]="null">Selecione...</mat-option>
                              @for (i of insumos(); track i.id) {
                                <mat-option [value]="i.id">{{ i.nome }}</mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                        }
                      </td>
                    </ng-container>

                    <!-- Quantidade -->
                    <ng-container matColumnDef="quantidade">
                      <th mat-header-cell *matHeaderCellDef>Quantidade</th>
                      <td mat-cell *matCellDef="let item">
                        @if (isView()) { {{ formatQuantidade(item.quantidade, item.unidadeMedidaId) }} }
                        @else {
                          <mat-form-field appearance="outline" class="cell-field">
                            <input matInput type="number"
                                   [ngModel]="getQuantidadeExibicao(item)"
                                   (ngModelChange)="onQuantidadeExibicaoChange(item, $event)"
                                   [ngModelOptions]="{standalone: true}"
                                   step="1" min="0" />
                          </mat-form-field>
                        }
                      </td>
                    </ng-container>

                    <!-- Unidade -->
                    <ng-container matColumnDef="unidade">
                      <th mat-header-cell *matHeaderCellDef>Unidade</th>
                      <td mat-cell *matCellDef="let item">
                        @if (isView()) { {{ getUnidadeSigla(item.unidadeMedidaId) }} }
                        @else {
                          <mat-form-field appearance="outline" class="cell-field">
                            <mat-select [(ngModel)]="item.unidadeMedidaId" [ngModelOptions]="{standalone: true}"
                                        (ngModelChange)="onUnidadeMedidaChangeItem(item)">
                              <mat-option [value]="null">Selecione...</mat-option>
                              @for (u of unidades(); track u.id) {
                                @if (['GR','ML','UN'].includes((u.sigla || '').toUpperCase())) {
                                  <mat-option [value]="u.id">{{ u.sigla }} - {{ u.nome }}</mat-option>
                                }
                              }
                            </mat-select>
                          </mat-form-field>
                        }
                      </td>
                    </ng-container>

                    <!-- QB -->
                    <ng-container matColumnDef="qb">
                      <th mat-header-cell *matHeaderCellDef class="col-qb">QB</th>
                      <td mat-cell *matCellDef="let item" class="col-qb">
                        @if (isView()) { {{ item.exibirComoQB ? 'Sim' : 'Não' }} }
                        @else { <mat-checkbox [(ngModel)]="item.exibirComoQB" [ngModelOptions]="{standalone: true}"></mat-checkbox> }
                      </td>
                    </ng-container>

                    <!-- Custo/un -->
                    <ng-container matColumnDef="custoPorUnidadeUso">
                      <th mat-header-cell *matHeaderCellDef>Custo / unidade</th>
                      <td mat-cell *matCellDef="let item">{{ formatarCustoPorUnidadeUso(item) }}</td>
                    </ng-container>

                    <!-- Custo -->
                    <ng-container matColumnDef="custo">
                      <th mat-header-cell *matHeaderCellDef>Custo</th>
                      <td mat-cell *matCellDef="let item">{{ formatCurrency(item.custoItem) }}</td>
                    </ng-container>

                    <!-- Observações -->
                    <ng-container matColumnDef="observacoes">
                      <th mat-header-cell *matHeaderCellDef>Obs.</th>
                      <td mat-cell *matCellDef="let item">
                        @if (isView()) { {{ item.observacoes || '-' }} }
                        @else {
                          <mat-form-field appearance="outline" class="cell-field">
                            <input matInput [(ngModel)]="item.observacoes" [ngModelOptions]="{standalone: true}" placeholder="Opcional" />
                          </mat-form-field>
                        }
                      </td>
                    </ng-container>

                    <!-- Ações -->
                    <ng-container matColumnDef="acoes">
                      <th mat-header-cell *matHeaderCellDef class="col-acoes">Ações</th>
                      <td mat-cell *matCellDef="let item; let i = index" class="col-acoes">
                        @if (!isView()) {
                          <div class="action-buttons">
                            <button mat-icon-button type="button" (click)="moveItemUp(i)" [disabled]="i === 0" matTooltip="Mover para cima">
                              <mat-icon>arrow_upward</mat-icon>
                            </button>
                            <button mat-icon-button type="button" (click)="moveItemDown(i)" [disabled]="i === itens().length - 1" matTooltip="Mover para baixo">
                              <mat-icon>arrow_downward</mat-icon>
                            </button>
                            <button mat-icon-button type="button" (click)="removeItem(i)" color="warn" matTooltip="Remover">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        }
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                  </table>
                </div>
              }

              @if (isMobile() && itens().length > 0) {
                <mat-accordion class="mobile-accordion">
                  @for (item of itens(); track $index; let i = $index) {
                    <mat-expansion-panel>
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          #{{ item.ordem }} — {{ getInsumoNome(item.insumoId) || 'Item sem insumo' }}
                        </mat-panel-title>
                        <mat-panel-description>
                          {{ formatCurrency(item.custoItem) }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      <!-- Reaproveite aqui seus campos mobile (ou o mesmo do desktop em colunas) -->
                      <!-- Mantive simples para focar no layout -->
                      <div class="mobile-item-grid">
                        <div class="row">
                          <div class="label">Quantidade</div>
                          <div class="value">{{ formatQuantidade(item.quantidade, item.unidadeMedidaId) }} {{ getUnidadeSigla(item.unidadeMedidaId) }}</div>
                        </div>
                      </div>

                      @if (!isView()) {
                        <div class="panel-actions">
                          <button mat-stroked-button type="button" (click)="removeItem(i)" color="warn">
                            <mat-icon>delete</mat-icon>
                            Remover
                          </button>
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                </mat-accordion>
              }
            </mat-card-content>
          </mat-card>
        </mat-tab>

        <!-- TAB 4: Preparo -->
        <mat-tab label="Preparo">
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>Modo de preparo</mat-card-title>
              <mat-card-subtitle>Instruções, conservação e empratamento</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content class="section-stack">
              <mat-form-field appearance="outline">
                <mat-label>Descrição do preparo</mat-label>
                <textarea matInput name="descricao" rows="6" [(ngModel)]="model.descricao" [disabled]="isView()" maxlength="5000"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Conservação</mat-label>
                <textarea matInput name="conservacao" rows="4" [(ngModel)]="model.conservacao" [disabled]="isView()" maxlength="5000"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Instruções de empratamento</mat-label>
                <textarea matInput name="instrucoesEmpratamento" rows="4" [(ngModel)]="model.instrucoesEmpratamento" [disabled]="isView()" maxlength="2000"></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>
        </mat-tab>

        <!-- TAB 5: Custos -->
        <mat-tab label="Custos">
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>Custos</mat-card-title>
              <mat-card-subtitle>Somente leitura</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content class="costs-grid">
              <div class="cost-tile">
                <div class="label">Custo total</div>
                <div class="value">{{ formatCurrency(custoTotalCalculado) }}</div>
              </div>

              <div class="cost-tile">
                <div class="label">Custo por porção</div>
                <div class="value">{{ formatCurrency(custoPorPorcaoCalculado) }}</div>
              </div>

              <div class="cost-note">
                Os custos são calculados automaticamente pelo sistema.
              </div>
            </mat-card-content>
          </mat-card>
        </mat-tab>
      </mat-tab-group>

      @if (error()) {
        <mat-card class="error-card">
          <mat-card-content>
            <mat-icon>error</mat-icon>
            <span>{{ error() }}</span>
          </mat-card-content>
        </mat-card>
      }

      <!-- Barra de ações sticky -->
      <div class="sticky-actions">
        <button mat-stroked-button type="button" routerLink="/tenant/receitas">Voltar</button>

        <span class="spacer"></span>

        <mat-slide-toggle name="isAtivo" [(ngModel)]="model.isAtivo" [disabled]="isView()">Ativo</mat-slide-toggle>

        @if (isView()) {
          <button mat-raised-button type="button" (click)="printPdf()">
            <mat-icon>print</mat-icon>
            Imprimir / PDF
          </button>
        } @else {
          <button mat-raised-button color="primary" type="submit">
            <mat-icon>save</mat-icon>
            Salvar
          </button>
        }
      </div>
    </form>
  </mat-sidenav-content>
</mat-sidenav-container>
