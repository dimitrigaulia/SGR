<div class="form-container">
  <h2 class="form-title">{{ isEdit() ? (isView() ? 'Visualizar insumo' : 'Editar insumo') : 'Cadastro de insumo' }}</h2>

  <form #f="ngForm" (ngSubmit)="save()">
    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Nome</mat-label>
      <input matInput name="nome" [(ngModel)]="model.nome" [disabled]="isView()" required maxlength="200" />
      @if (f.controls['nome']?.errors?.['required']) {
        <mat-error>Nome é obrigatório</mat-error>
      }
    </mat-form-field>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Categoria</mat-label>
        <mat-select name="categoriaId" [(ngModel)]="model.categoriaId" [disabled]="isView()" required>
          @for (c of categorias(); track c.id) {
            <mat-option [value]="c.id">{{ c.nome }}</mat-option>
          }
        </mat-select>
        @if (f.controls['categoriaId']?.errors?.['required']) {
          <mat-error>Categoria é obrigatória</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Unidade de Compra</mat-label>
        <mat-select name="unidadeCompraId" [(ngModel)]="model.unidadeCompraId" [disabled]="isView()" required>
          @for (u of unidades(); track u.id) {
            <mat-option [value]="u.id">{{ u.nome }} ({{ u.sigla }})</mat-option>
          }
        </mat-select>
        @if (f.controls['unidadeCompraId']?.errors?.['required']) {
          <mat-error>Unidade de compra é obrigatória</mat-error>
        }
        <mat-hint>Unidade em que o insumo é comprado</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Unidade de Uso</mat-label>
        <mat-select name="unidadeUsoId" [(ngModel)]="model.unidadeUsoId" [disabled]="isView()" required>
          @for (u of unidades(); track u.id) {
            <mat-option [value]="u.id">{{ u.nome }} ({{ u.sigla }})</mat-option>
          }
        </mat-select>
        @if (f.controls['unidadeUsoId']?.errors?.['required']) {
          <mat-error>Unidade de uso é obrigatória</mat-error>
        }
        <mat-hint>Unidade usada nas receitas</mat-hint>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Quantidade por Embalagem</mat-label>
        <input matInput type="number" name="quantidadePorEmbalagem" [(ngModel)]="model.quantidadePorEmbalagem" [disabled]="isView()" required min="0.0001" step="0.0001" />
        <mat-hint>Ex: 12 unidades, 5 kg</mat-hint>
        @if (f.controls['quantidadePorEmbalagem']?.errors?.['required']) {
          <mat-error>Quantidade por embalagem é obrigatória</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Fator de Correção</mat-label>
        <input matInput type="number" name="fatorCorrecao" [(ngModel)]="model.fatorCorrecao" [disabled]="isView()" required min="1.0" step="0.01" />
        <mat-hint>Ex: 1.10 = 10% de perda</mat-hint>
        @if (f.controls['fatorCorrecao']?.errors?.['min']) {
          <mat-error>Fator de correção deve ser maior ou igual a 1.0</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Custo Unitário</mat-label>
        <input matInput type="number" name="custoUnitario" [(ngModel)]="model.custoUnitario" [disabled]="isView()" required min="0" step="0.01" />
        <span matTextPrefix>R$&nbsp;</span>
        <mat-hint>Custo por unidade de compra</mat-hint>
        @if (f.controls['custoUnitario']?.errors?.['required']) {
          <mat-error>Custo unitário é obrigatório</mat-error>
        }
        @if (f.controls['custoUnitario']?.errors?.['min']) {
          <mat-error>Custo unitário deve ser maior ou igual a zero</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Estoque Mínimo</mat-label>
        <input matInput type="number" name="estoqueMinimo" [(ngModel)]="model.estoqueMinimo" [disabled]="isView()" min="0" step="0.01" />
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Descrição</mat-label>
      <textarea matInput name="descricao" [(ngModel)]="model.descricao" [disabled]="isView()" rows="3"></textarea>
    </mat-form-field>

    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Código de Barras</mat-label>
      <input matInput name="codigoBarras" [(ngModel)]="model.codigoBarras" (blur)="onCodigoBarrasBlur(model.codigoBarras || '')" [disabled]="isView()" maxlength="50" />
      @if (codigoBarrasTaken) {
        <mat-error>Este código de barras já está em uso</mat-error>
      }
    </mat-form-field>

    <!-- Wrapper para o toggle com espaçamento consistente -->
    <div class="form-toggle-wrapper">
      <mat-slide-toggle name="isAtivo" [(ngModel)]="model.isAtivo" [disabled]="isView()">Ativo</mat-slide-toggle>
    </div>

    <div class="imagem-row form-section">
      @if (model.pathImagem) {
        <img [src]="model.pathImagem" alt="insumo" width="64" height="64" style="border-radius:4px; object-fit:cover" />
      }
      <button mat-stroked-button type="button" (click)="triggerFile()" [disabled]="isView()">{{ model.pathImagem ? 'Alterar imagem' : 'Adicionar imagem' }}</button>
      @if (model.pathImagem && !isView()) {
        <button mat-button type="button" color="warn" (click)="clearImage()">Remover</button>
      }
      <input type="file" accept="image/png,image/jpeg" hidden #fileInput (change)="onFile($event)" />
    </div>

    @if (error()) {
      <div class="form-error">{{ error() }}</div>
    }

    <div class="form-actions">
      <button mat-stroked-button type="button" routerLink="/tenant/insumos">Voltar</button>
      @if (!isView()) {
        <button mat-raised-button color="primary" type="submit">Salvar</button>
      }
    </div>
  </form>
</div>

