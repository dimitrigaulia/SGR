<div class="form-container">
  <h2 class="form-title">
    {{ isEdit() ? (isView() ? 'Visualizar insumo' : 'Editar insumo') : 'Cadastro de insumo' }}
  </h2>

  <!-- QUICK SUMMARY (somente o que √© "principal" para o usu√°rio) -->
  <div class="quick-summary two-cols">
    @if (model.custoUnitario > 0 && model.quantidadePorEmbalagem > 0 && resumoCustoPorUnidade !== '-') {
      <div class="quick-card primary">
        <div class="quick-label">
          <span>Custo por unidade limpa</span>
          <span class="auto-badge" matTooltip="Valor calculado automaticamente">‚ö° auto</span>
        </div>
        <div class="quick-value">{{ resumoCustoPorUnidade }}</div>
      </div>
    }

    @if (model.quantidadePorEmbalagem > 0 && (model.ipcValor || 0) > 0 && aproveitamentoPercentualNumero < 100) {
      <div class="quick-card">
        <div class="quick-label">
          <span>Aproveitamento</span>
          <span class="auto-badge" matTooltip="Valor calculado automaticamente">‚ö° auto</span>
        </div>
        <div class="quick-value muted">{{ aproveitamentoPercentual }}</div>
      </div>
    }
  </div>

  <form #f="ngForm" (ngSubmit)="save()">
    <!-- DADOS B√ÅSICOS -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title class="section-title">Dados b√°sicos</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="form-field-spacing">
          <mat-label>Nome</mat-label>
          <input
            matInput
            name="nome"
            [(ngModel)]="model.nome"
            [disabled]="isView()"
            required
            maxlength="200"
          />
          @if (f.controls['nome']?.errors?.['required']) {
            <mat-error>Nome √© obrigat√≥rio</mat-error>
          }
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-spacing">
            <mat-label>Categoria</mat-label>
            <mat-select name="categoriaId" [(ngModel)]="model.categoriaId" [disabled]="isView()" required>
              @for (c of categorias(); track c.id) {
                <mat-option [value]="c.id">{{ c.nome }}</mat-option>
              }
            </mat-select>
            @if (f.controls['categoriaId']?.errors?.['required']) {
              <mat-error>Categoria √© obrigat√≥ria</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-spacing">
            <mat-label>Unidade</mat-label>
            <mat-select name="unidadeCompraId" [(ngModel)]="model.unidadeCompraId" [disabled]="isView()" required>
              @for (u of unidades(); track u.id) {
                <mat-option [value]="u.id">{{ u.nome }} ({{ u.sigla }})</mat-option>
              }
            </mat-select>
            @if (f.controls['unidadeCompraId']?.errors?.['required']) {
              <mat-error>Unidade √© obrigat√≥ria</mat-error>
            }
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- COMPRA E APROVEITAMENTO -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title class="section-title">Compra e aproveitamento</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-spacing" subscriptSizing="dynamic">
            <mat-label>Quantidade por embalagem @if (unidadeCompraSelecionada) { ({{ unidadeCompraSelecionada.sigla }}) }</mat-label>
            <input
              matInput
              type="text"
              name="quantidadePorEmbalagem"
              [(ngModel)]="quantidadePorEmbalagemStr"
              (ngModelChange)="onQuantidadePorEmbalagemChange($event)"
              (keydown)="onNumericKeyDown($event)"
              [disabled]="isView()"
              required
              pattern="[0-9.,]+"
              inputmode="decimal"
            />
            <mat-hint class="hint-responsive">Quanto vem na embalagem comprada. Ex: pacote de 500g, garrafa de 2L</mat-hint>
            @if (f.controls['quantidadePorEmbalagem']?.invalid && f.controls['quantidadePorEmbalagem']?.touched) {
              <mat-error>Quantidade por embalagem √© obrigat√≥ria e deve ser maior que zero</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-spacing" subscriptSizing="dynamic">
            <mat-label>
              Quantidade limpa/aproveit√°vel @if (unidadeCompraSelecionada) { ({{ unidadeCompraSelecionada.sigla }}) }
              <mat-icon class="help-icon" matTooltip="Quanto sobra ap√≥s limpar/preparar o insumo (descascar, desossar, etc.). Tamb√©m conhecido como IPC (√çndice de Parte Comest√≠vel)">help_outline</mat-icon>
            </mat-label>
            <input
              matInput
              #ipcInput
              type="text"
              name="ipcValor"
              [(ngModel)]="ipcValorStr"
              (ngModelChange)="onIPCValorChange($event)"
              (keydown)="onNumericKeyDown($event)"
              [disabled]="isView()"
              pattern="[0-9.,]+"
              inputmode="decimal"
            />
            <mat-hint class="hint-responsive">Quanto sobra ap√≥s limpeza. <strong>Exemplos COM perda:</strong> batata descascada, frango sem osso, alface sem talo. <strong>SEM perda:</strong> √≥leo, a√ß√∫car, arroz. Se n√£o houver perda, mantenha igual √† quantidade</mat-hint>

            @if (ipcEditadoManualmente() && !isView()) {
              <button
                mat-icon-button
                type="button"
                matSuffix
                (click)="resetarIPC()"
                matTooltip="Resetar para valor padr√£o (sem perda)"
                class="suffix-icon"
              >
                <mat-icon>refresh</mat-icon>
              </button>
            }

            @if (model.ipcValor && model.ipcValor <= 0) {
              <mat-error>Quantidade limpa deve ser maior que zero</mat-error>
            }
            @if (model.ipcValor && model.quantidadePorEmbalagem > 0 && model.ipcValor > model.quantidadePorEmbalagem) {
              <mat-error>Quantidade limpa n√£o pode ser maior que a quantidade por embalagem</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-spacing">
            <mat-label>Custo da embalagem completa</mat-label>
            <span matTextPrefix>R$&nbsp;</span>
            <input
              matInput
              type="text"
              name="custoUnitario"
              [(ngModel)]="custoUnitarioStr"
              (ngModelChange)="onCustoUnitarioChange($event)"
              (keydown)="onNumericKeyDown($event)"
              [disabled]="isView()"
              required
              pattern="[0-9.,]+"
              inputmode="decimal"
            />
            @if (f.controls['custoUnitario']?.invalid && f.controls['custoUnitario']?.touched) {
              <mat-error>Custo da embalagem √© obrigat√≥rio e deve ser maior que zero</mat-error>
            }
          </mat-form-field>

          <div class="grid-spacer"></div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- UNIDADES INDIVIDUAIS (OPCIONAL) -->
    <mat-expansion-panel class="section-panel" [expanded]="(model.unidadesPorEmbalagem ?? 0) > 0">
      <mat-expansion-panel-header>
        <mat-panel-title>Unidades individuais (opcional)</mat-panel-title>

        <mat-panel-description>
          @if ((model.unidadesPorEmbalagem ?? 0) > 0 && (model.pesoPorUnidade ?? 0) > 0) {
            {{ model.unidadesPorEmbalagem }} un ‚Ä¢ {{ model.pesoPorUnidade }} @if (unidadeCompraSelecionada) { {{ obterUnidadeBase() }} }
          } @else if ((model.unidadesPorEmbalagem ?? 0) > 0) {
            {{ model.unidadesPorEmbalagem }} un por embalagem
          } @else {
            Use quando a embalagem cont√©m itens individuais (ex: pacote com 8 salsichas, bandeja com 6 ovos)
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-spacing" subscriptSizing="dynamic">
          <mat-label>Unidades por embalagem</mat-label>
          <input
            matInput
            type="text"
            name="unidadesPorEmbalagem"
            [(ngModel)]="unidadesPorEmbalagemStr"
            (ngModelChange)="onUnidadesPorEmbalagemChange($event)"
            (keydown)="onIntegerKeyDown($event)"
            [disabled]="isView()"
            pattern="[0-9]+"
            inputmode="numeric"
          />
          <mat-hint class="hint-responsive">Quantas unidades individuais v√™m na embalagem. Ex: 8 salsichas, 12 ovos</mat-hint>
          @if (model.unidadesPorEmbalagem && model.unidadesPorEmbalagem <= 0) {
            <mat-error>Unidades por embalagem deve ser maior que zero</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field-spacing" subscriptSizing="dynamic">
          <mat-label>{{ obterLabelPesoPorUnidade() }}</mat-label>
          <input
            matInput
            type="text"
            name="pesoPorUnidade"
            [(ngModel)]="pesoPorUnidadeStr"
            (ngModelChange)="onPesoPorUnidadeChange($event)"
            (keydown)="onNumericKeyDown($event)"
            [disabled]="isView()"
            pattern="[0-9.,]+"
            inputmode="decimal"
          />

          <button
            mat-stroked-button
            matSuffix
            type="button"
            (click)="calcularPesoPorUnidade()"
            [disabled]="isView() || !(model.unidadesPorEmbalagem && model.quantidadePorEmbalagem)"
            [matTooltip]="getCalcularTooltip()"
          >
            Calcular
          </button>

          <mat-hint class="hint-responsive">Usado para converter unidades ‚Üí {{ obterUnidadeBase() }} na ficha t√©cnica</mat-hint>

          @if (model.pesoPorUnidade && model.pesoPorUnidade <= 0) {
            <mat-error>{{ obterUnidadeBase() === 'mL' ? 'Volume' : 'Peso' }} m√©dio deve ser maior que zero</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- CUSTO POR UNIDADE INDIVIDUAL -->
      @if (resumoCustoPorUnidadeLimpa !== '-') {
        <div class="panel-metric">
          <span class="panel-metric-label">Custo por unidade individual</span>
          <span class="panel-metric-value">{{ resumoCustoPorUnidadeLimpa }}</span>
        </div>
      }
    </mat-expansion-panel>

    <!-- RESUMO DE CUSTOS -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title class="section-title">Resumo de custos</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="summary-row">
          <span>Custo da embalagem completa</span>
          <strong>{{ resumoCustoPorUnidadeCompra }}</strong>
        </div>

        @if (exemploIPC) {
          <div class="summary-note">üí° {{ exemploIPC }}</div>
        }

        <div class="summary-footnote">
          ‚ö° Valores calculados automaticamente com base na unidade, quantidade por embalagem e quantidade limpa.
        </div>
      </mat-card-content>
    </mat-card>

    <!-- INFORMA√á√ïES ADICIONAIS -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title class="section-title">Informa√ß√µes adicionais</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="form-field-spacing">
          <mat-label>Descri√ß√£o</mat-label>
          <textarea matInput name="descricao" [(ngModel)]="model.descricao" [disabled]="isView()" rows="3" maxlength="1000"></textarea>
          <mat-hint>Observa√ß√µes ou informa√ß√µes extras sobre o insumo</mat-hint>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <div class="form-toggle-wrapper">
      <mat-slide-toggle name="isAtivo" [(ngModel)]="model.isAtivo" [disabled]="isView()">Ativo</mat-slide-toggle>
    </div>

    @if (error()) {
      <div class="form-error">{{ error() }}</div>
    }

    <div class="form-actions">
      <button mat-stroked-button type="button" routerLink="/tenant/insumos">Voltar</button>
      @if (!isView()) {
        <button mat-raised-button color="primary" type="submit">Salvar</button>
      }
    </div>
  </form>
</div>
