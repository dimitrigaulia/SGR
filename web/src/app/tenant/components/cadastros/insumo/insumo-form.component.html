<div class="form-container">
  <h2 class="form-title">{{ isEdit() ? (isView() ? 'Visualizar insumo' : 'Editar insumo') : 'Cadastro de insumo' }}</h2>

  <mat-card class="form-field-spacing" *ngIf="!isView()">
    <mat-card-content>
      <div style="font-size: 13px; margin-bottom: 4px; font-weight: 500;">
        Passos para cadastrar um insumo:
      </div>
      <ol style="margin: 0 0 0 16px; padding: 0; font-size: 13px;">
        <li>Escolha a categoria do insumo.</li>
        <li>Informe a unidade de medida, quantidade por embalagem e custo da embalagem.</li>
        <li>Essa unidade será usada nas receitas (g, mL ou un).</li>
        <li>O IPC será preenchido automaticamente. Ajuste apenas se houver perda.</li>
      </ol>
    </mat-card-content>
  </mat-card>

  <form #f="ngForm" (ngSubmit)="save()">
    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Nome</mat-label>
      <input matInput name="nome" [(ngModel)]="model.nome" [disabled]="isView()" required maxlength="200" />
      @if (f.controls['nome']?.errors?.['required']) {
        <mat-error>Nome é obrigatório</mat-error>
      }
    </mat-form-field>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Categoria</mat-label>
        <mat-select name="categoriaId" [(ngModel)]="model.categoriaId" [disabled]="isView()" required>
          @for (c of categorias(); track c.id) {
            <mat-option [value]="c.id">{{ c.nome }}</mat-option>
          }
        </mat-select>
        @if (f.controls['categoriaId']?.errors?.['required']) {
          <mat-error>Categoria é obrigatória</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Unidade de Medida</mat-label>
        <mat-select name="unidadeCompraId" [(ngModel)]="model.unidadeCompraId" [disabled]="isView()" required>
          @for (u of unidades(); track u.id) {
            <mat-option [value]="u.id">{{ u.nome }} ({{ u.sigla }})</mat-option>
          }
        </mat-select>
        <mat-hint class="hint-responsive">Unidade de medida do insumo (recomendado: g, mL ou un)</mat-hint>
        @if (f.controls['unidadeCompraId']?.errors?.['required']) {
          <mat-error>Unidade de medida é obrigatória</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Quantidade por Embalagem</mat-label>
        <input matInput type="text" name="quantidadePorEmbalagem" [value]="model.quantidadePorEmbalagem > 0 ? model.quantidadePorEmbalagem : ''" (input)="onQuantidadePorEmbalagemInput($event)" [disabled]="isView()" required pattern="[0-9.,]+" />
        <mat-hint class="hint-responsive">
          Aceita ponto ou vírgula como separador decimal (ex: 1000,5 ou 1000.5)
        </mat-hint>
        @if (f.controls['quantidadePorEmbalagem']?.errors?.['required']) {
          <mat-error>Quantidade por embalagem é obrigatória</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>IPC (quantidade aproveitável)</mat-label>
        <input matInput #ipcInput type="text" name="ipcValor" [value]="model.ipcValor && model.ipcValor > 0 ? model.ipcValor : ''" (input)="onIPCInput($event)" [disabled]="isView()" pattern="[0-9.,]+" />
        <mat-hint class="hint-responsive">Quanto dessa embalagem é realmente usado na receita. Se aproveita tudo, deixe igual à Quantidade por Embalagem. Aceita ponto ou vírgula como separador decimal.</mat-hint>
        @if (ipcEditadoManualmente() && !isView()) {
          <button mat-icon-button type="button" matSuffix (click)="resetarIPC()" matTooltip="Resetar IPC = Quantidade por Embalagem" style="margin-right: -8px;">
            <mat-icon style="font-size: 18px; width: 18px; height: 18px;">refresh</mat-icon>
          </button>
        }
        @if (model.ipcValor && model.ipcValor <= 0) {
          <mat-error>IPC deve ser maior que zero</mat-error>
        }
        @if (model.ipcValor && model.quantidadePorEmbalagem > 0 && model.ipcValor > model.quantidadePorEmbalagem) {
          <mat-error>IPC não pode ser maior que Quantidade por Embalagem</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Custo da Embalagem</mat-label>
        <input matInput type="text" name="custoUnitario" [value]="model.custoUnitario > 0 ? model.custoUnitario : ''" (input)="onCustoInput($event)" [disabled]="isView()" required pattern="[0-9.,]+" />
        <span matTextPrefix>R$&nbsp;</span>
        <mat-hint class="hint-responsive">Custo do item comprado (embalagem). Aceita ponto ou vírgula como separador decimal.</mat-hint>
        @if (f.controls['custoUnitario']?.errors?.['required']) {
          <mat-error>Custo da embalagem é obrigatório</mat-error>
        }
        @if (model.custoUnitario < 0) {
          <mat-error>Custo da embalagem deve ser maior ou igual a zero</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- <mat-card class="form-field-spacing">
      <mat-card-content>
        <div style="display: flex; justify-content: space-between; gap: 8px;">
          <span>Conversão entre compra e uso:</span>
          <span style="font-weight: 500;">{{ tiposUnidadeMensagem }}</span>
        </div>
      </mat-card-content>
    </mat-card> -->

    <mat-card class="form-field-spacing">
      <mat-card-header>
        <mat-card-title style="font-size: 14px;">Resumo de custos</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 8px;">
          <span>Custo por embalagem:</span>
          <span style="font-weight: 500;">{{ resumoCustoPorUnidadeCompra }}</span>
        </div>
        <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 8px;">
          <span>Custo por unidade usada na receita:</span>
          <span style="font-weight: 500;">{{ resumoCustoPorUnidade }}</span>
        </div>
        @if (aproveitamentoPercentual !== '-') {
          <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 8px;">
            <span>Aproveitamento (IPC ÷ Embalagem):</span>
            <span style="font-weight: 500; color: var(--mat-app-text-color); opacity: 0.7; font-size: 13px;">{{ aproveitamentoPercentual }}</span>
          </div>
        }
        @if (exemploIPC) {
          <div style="margin-top: 8px; font-size: 12px; color: var(--mat-app-text-color); opacity: 0.7;">
            Ex.: {{ exemploIPC }}
          </div>
        }
        <div style="margin-top: 8px; font-size: 12px; color: var(--mat-app-text-color); opacity: 0.7;">
          Valores calculados automaticamente com base nas unidades, quantidade por embalagem e IPC.
        </div>
      </mat-card-content>
    </mat-card>

    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Descrição</mat-label>
      <textarea matInput name="descricao" [(ngModel)]="model.descricao" [disabled]="isView()" rows="3"></textarea>
    </mat-form-field>

    <div class="form-toggle-wrapper">
      <mat-slide-toggle name="isAtivo" [(ngModel)]="model.isAtivo" [disabled]="isView()">Ativo</mat-slide-toggle>
    </div>

    <!-- <div class="imagem-row form-section">
      @if (model.pathImagem) {
        <img [src]="model.pathImagem" alt="insumo" width="64" height="64" style="border-radius:4px; object-fit:cover" />
      }
      <button mat-stroked-button type="button" (click)="triggerFile()" [disabled]="isView()">{{ model.pathImagem ? 'Alterar imagem' : 'Adicionar imagem' }}</button>
      @if (model.pathImagem && !isView()) {
        <button mat-button type="button" color="warn" (click)="clearImage()">Remover</button>
      }
      <input type="file" accept="image/png,image/jpeg" hidden #fileInput (change)="onFile($event)" />
    </div> -->

    @if (error()) {
      <div class="form-error">{{ error() }}</div>
    }

    <div class="form-actions">
      <button mat-stroked-button type="button" routerLink="/tenant/insumos">Voltar</button>
      @if (!isView()) {
        <button mat-raised-button color="primary" type="submit">Salvar</button>
      }
    </div>
  </form>
</div>
