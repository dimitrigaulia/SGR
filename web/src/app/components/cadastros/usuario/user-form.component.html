<div class="form-container">
  <h2 class="form-title">{{ isEdit() ? (isView() ? 'Visualizar usuário' : 'Editar usuário') : 'Cadastro de usuário' }}</h2>

  <form #f="ngForm" (ngSubmit)="save()">
    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Nome completo</mat-label>
      <input matInput name="nomeCompleto" [(ngModel)]="model.nomeCompleto" [disabled]="isView()" required maxlength="200" />
      @if (f.controls['nomeCompleto']?.errors?.['required']) {
        <mat-error>Nome é obrigatório</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Email</mat-label>
      <input matInput type="email" name="email" [(ngModel)]="model.email" (blur)="onEmailBlur(model.email)" [disabled]="isView()" required maxlength="200" />
      @if (f.controls['email']?.errors?.['required']) {
        <mat-error>Email é obrigatório</mat-error>
      }
      @if (f.controls['email']?.errors?.['email']) {
        <mat-error>Email inválido</mat-error>
      }
      @if (emailTaken) {
        <mat-error>Este email já está em uso</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="form-field-spacing">
      <mat-label>Perfil</mat-label>
      <mat-select name="perfilId" [(ngModel)]="model.perfilId" [disabled]="isView()" required>
        @for (p of perfis(); track p.id) {
          <mat-option [value]="p.id">{{ p.nome }}</mat-option>
        }
      </mat-select>
      @if (f.controls['perfilId']?.errors?.['required']) {
        <mat-error>Perfil é obrigatório</mat-error>
      }
    </mat-form-field>

    <!-- Wrapper para o toggle com espaçamento consistente -->
    <div class="form-toggle-wrapper">
      <mat-slide-toggle name="isAtivo" [(ngModel)]="model.isAtivo" [disabled]="isView()">Ativo</mat-slide-toggle>
    </div>

    @if (!isEdit()) {
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Senha</mat-label>
        <input matInput type="password" name="senha" [(ngModel)]="model.senha" [disabled]="isView()" />
      </mat-form-field>
    }

    @if (isEdit()) {
      <mat-form-field appearance="outline" class="form-field-spacing">
        <mat-label>Nova senha (opcional)</mat-label>
        <input matInput type="password" name="novaSenha" [(ngModel)]="model.novaSenha" [disabled]="isView()" />
      </mat-form-field>
    }

    <div class="avatar-row form-section">
      @if (model.pathImagem) {
        <img [src]="model.pathImagem" alt="avatar" width="64" height="64" style="border-radius:50%" />
      }
      <button mat-stroked-button type="button" (click)="triggerFile()" [disabled]="isView()">{{ model.pathImagem ? 'Alterar foto' : 'Adicionar foto' }}</button>
      @if (model.pathImagem && !isView()) {
        <button mat-button type="button" color="warn" (click)="clearAvatar()">Remover</button>
      }
      <input type="file" accept="image/png,image/jpeg" hidden #fileInput (change)="onFile($event)" />
    </div>

    @if (error()) {
      <div class="form-error">{{ error() }}</div>
    }

    <div class="form-actions">
      <button mat-stroked-button type="button" routerLink="/usuarios">Voltar</button>
      @if (!isView()) {
        <button mat-raised-button color="primary" type="submit">Salvar</button>
      }
    </div>
  </form>
</div>

